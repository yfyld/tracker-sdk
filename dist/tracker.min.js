!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("lodash/fp")):"function"==typeof define&&define.amd?define(["exports","lodash/fp"],e):e(t.tracker={},t.fp)}(this,function(t,c){"use strict";var o=function(){return(o=Object.assign||function(t){for(var e,n=1,a=arguments.length;n<a;n++)for(var i in e=arguments[n])Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i]);return t}).apply(this,arguments)};function r(t){return void 0!==t.oldValue&&("object"==typeof t.value?c.isEqual(t.value,t.oldValue):t.value===t.oldValue)}function s(t){return""===t.value||void 0===t.value||null===t.value}function a(t,e){void 0===e&&(e=!0),window._trackerFlag=window._trackerFlag||{},window._trackerFlag[t]=e}function d(t){return window._trackerFlag=window._trackerFlag||{},window._trackerFlag[t]||!1}var u="http://127.0.0.1:7001/event/track.gif",i="TRACKER_DATA_KEY",n="TRACKER_IDENTIFY",l="SYNC",f="ASYNC",h="UNLOAD",p="EVENT",v="PAGE",e="PAGE_TIME",m={_keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",encode:function(t){var e,n,a,i,r,o,c,s="",d=0;for(t=m._utf8_encode(t);d<t.length;)i=(e=t.charCodeAt(d++))>>2,r=(3&e)<<4|(n=t.charCodeAt(d++))>>4,o=(15&n)<<2|(a=t.charCodeAt(d++))>>6,c=63&a,isNaN(n)?o=c=64:isNaN(a)&&(c=64),s=s+this._keyStr.charAt(i)+this._keyStr.charAt(r)+this._keyStr.charAt(o)+this._keyStr.charAt(c);return s},decode:function(t){var e,n,a,i,r,o,c="",s=0;for(t=t.replace(/[^A-Za-z0-9\+\/\=]/g,"");s<t.length;)e=this._keyStr.indexOf(t.charAt(s++))<<2|(i=this._keyStr.indexOf(t.charAt(s++)))>>4,n=(15&i)<<4|(r=this._keyStr.indexOf(t.charAt(s++)))>>2,a=(3&r)<<6|(o=this._keyStr.indexOf(t.charAt(s++))),c+=String.fromCharCode(e),64!=r&&(c+=String.fromCharCode(n)),64!=o&&(c+=String.fromCharCode(a));return c=m._utf8_decode(c)},_utf8_encode:function(t){t=t.replace(/\r\n/g,"\n");for(var e="",n=0;n<t.length;n++){var a=t.charCodeAt(n);a<128?e+=String.fromCharCode(a):(127<a&&a<2048?e+=String.fromCharCode(a>>6|192):(e+=String.fromCharCode(a>>12|224),e+=String.fromCharCode(a>>6&63|128)),e+=String.fromCharCode(63&a|128))}return e},_utf8_decode:function(t){for(var e="",n=0,a=0,i=0,r=0;n<t.length;)(a=t.charCodeAt(n))<128?(e+=String.fromCharCode(a),n++):191<a&&a<224?(r=t.charCodeAt(n+1),e+=String.fromCharCode((31&a)<<6|63&r),n+=2):(r=t.charCodeAt(n+1),i=t.charCodeAt(n+2),e+=String.fromCharCode((15&a)<<12|(63&r)<<6|63&i),n+=3);return e}};var g={libVersion:"1.0.0",libType:"js"};var y={pageTime:!0,env:"production",console:!0,projectId:null,token:null,version:null,domain:"",sendType:h,delayTime:1e3,autoTrakerPage:!1,autoTrakerClick:!0,autoInstall:!0,delayLink:!0,delayLinkTime:200,useServerTime:!0,corssSubdomain:!0,analyseScript:"../dist/analyse.min.js"},k=document.querySelector("script[tracker-key]");if(k){var w=m.decode(k.getAttribute("tracker-key")||"");w&&(y=o({},y,JSON.parse(w)))}function T(){return y}function I(t){y=o({},y,t)}var S={userId:null};var C=[],x=null,N="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){var e=16*Math.random()|0;return("x"==t?e:3&e|8).toString(16)}),E=0;function _(t){var e=T(),n=e.sendType;if(t=D(t,e),e.console&&console.log(t),n===h){var a=JSON.parse(localStorage.getItem(i)||"[]");localStorage.setItem(i,JSON.stringify(a.concat(t)))}else n===l?L([t]):n===f&&(C.push(t),A(e.delayTime))}function b(){var t=localStorage.getItem(i);t&&"[]"!==t&&L(t).then(function(){localStorage.removeItem(i)})}function A(t,e){if(void 0===t&&(t=0),void 0===e&&(e=!1),C.length){if(clearTimeout(x),e)return L(JSON.stringify(C)),void(C.length=0);x=setTimeout(function(){L(JSON.stringify(C)),C.length=0},t)}}function L(t,e){return function(o,c,s){return void 0===c&&(c=!1),void 0===s&&(s=!0),new Promise(function(t,e){o=m.encode(JSON.stringify(o));var n=u+"?time="+Date.now();if(s&&"function"==typeof window.navigator.sendBeacon&&"function"==typeof Blob){var a=new Blob([o],{type:"text/plain; charset=UTF-8"});if(window.navigator.sendBeacon(n,a))return void t()}if(c||8e3<o.length){var i=new XMLHttpRequest;i.withCredentials=!0,i.addEventListener("readystatechange",function(){4===this.readyState&&t()}),i.open("POST",n,!0),i.setRequestHeader("Content-Type","text/plain;charset=UTF-8"),i.withCredentials=!0,i.send(o)}else{var r=new Image;r.onload=function(){t()},r.src=n+"&data="+o}})}(t,e)}function D(t,e){return E++,o({},t,{clientWidth:window.screen.height,clientHeight:window.screen.width,title:document.title||"",referrer:document.referrer||"",domain:document.domain||""},g,S,{trackTime:Date.now(),useServerTime:e.useServerTime,identify:function(t){var e=document.cookie.split("");for(var n in e){var a=e[n].split("=");if(t==a[0])return unescape(a[1]).replace(/&&&&/g,";")}return null}(e.identify||n),projectId:e.projectId,version:e.version,uuid:N+"-"+E})}var j=function(){function t(){this.pageId=document.querySelector('meta[name="tracker-id"]').content||null}return t.getInstance=function(){return t.instance||(t.instance=new t),t.instance},t.prototype.trackPage=function(t){void 0===t&&(t={});var e=o({actionType:v,url:location.origin,host:location.host,path:location.pathname,hash:location.hash,pageId:this.pageId},t);this.pageId=e.pageId,window._trackerPageId=this.pageId,_(e)},t.prototype.trackEvent=function(t){void 0===t&&(t={});var e=o({actionType:v,eventName:"CLICK",url:location.origin,host:location.host,path:location.pathname,hash:location.hash},t);this.pageId=e.pageId,_(e)},t.prototype.track=function(t){void 0===t&&(t={}),_(o({actionType:p,eventName:"CLICK",pageId:this.pageId,url:location.origin,host:location.host,path:location.pathname,hash:location.hash},t))},t.prototype.trackLink=function(e,t){(void 0===t&&(t={}),e.addEventListener("click",function(t){t.preventDefault(),setTimeout(function(){e.click()},300)},!1),t)&&_(o({actionType:p,eventName:"CLICK",url:location.origin,host:location.host,path:location.pathname,hash:location.hash},t))},t.prototype.trackDom=function(t,e){void 0===e&&(e={});var n={domId:t.id,domClass:t.className,domHref:t.href||"",domName:t.name||"",domTag:t.tagName,domContent:t.textContent.substr(0,20),domPath:function(t){for(var e=[t.id?"#"+t.id:t.tagName.toLowerCase()];t.parentNode&&"BODY"!==t.parentNode.tagName;)t=t.parentNode,e.unshift(t.id?"#"+t.id:t.tagName.toLowerCase());return e.join(">")}(t),pageId:this.pageId},a=t.dataset.track;a&&0<=a.search(/^\{[\S\s]*\}$/)?n=o({},n,JSON.parse(a)):n.trackId=a||"",e&&(n=o({},n,e)),this.track(n)},t.instance=null,t}().getInstance(),O=function(){function t(){this.startTime=Date.now(),this.endTime=Date.now(),this.pageTimes=[],this.invalidStartTime=Date.now(),this.invalidEndTime=Date.now(),this.totalInvalidTime=0,this.url=location.origin,this.pageId=null}return t.getInstance=function(){return t.instance||(t.instance=new t),t.instance},t.prototype.start=function(){var t=this;this.startTime=Date.now(),this.pageTimes=[],this.pageId=j.pageId,window.addEventListener("visibilitychange",function(){document.hidden?t.invalidStartTime=Date.now():(t.invalidEndTime=Date.now(),t.totalInvalidTime+=t.invalidEndTime-t.invalidStartTime)})},t.prototype.end=function(){this.change(),_({actionType:e,url:location.origin,host:location.host,path:location.pathname,hash:location.hash,pageId:this.pageId,startTime:this.startTime,endTime:this.endTime,pageTimes:this.pageTimes,invalidTime:this.totalInvalidTime})},t.prototype.change=function(){this.pageId=j.pageId,this.pageTimes.push({url:this.url,href:location.href,pageId:this.pageId,startTime:this.endTime,invalidTime:this.invalidEndTime-this.invalidStartTime,endTime:Date.now()}),this.invalidEndTime=this.invalidStartTime=this.endTime=Date.now()},t.instance=null,t}().getInstance(),P=c.curryN(2,function(i,r){return function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];if(c.isFunction(i))try{var n=i.apply(this,t);"object"==typeof n&&j.track(n)}catch(t){console.error(t)}else if("object"==typeof i)j.track(i);else if("string"==typeof i){var a={trackId:i};j.track(a)}return r.apply(this,t)}}),F=c.curryN(2,function(r,o){return function(){for(var n=this,a=[],t=0;t<arguments.length;t++)a[t]=arguments[t];var e=o.apply(this,a),i=function(){if(c.isFunction(r))try{var t=r.apply(n,a);"object"==typeof t&&j.track(t)}catch(t){console.error(t)}else if("object"==typeof r)j.track(r);else if("string"==typeof r){var e={trackId:r};j.track(e)}};return function(t){return t&&c.isFunction(t.then)}(e)?e.then(function(t){return i(),t}):(i(),e)}}),R=[],U={bind:function(e,t){var n=R.findIndex(function(t){return t===e}),a=-1!==n;if("none"!==e.style.display){if(a&&R.splice(n,1),a||!r(t)&&!s(t)){var i={};"object"==typeof t.value?i=t.value:"string"==typeof t.value&&t.value&&(i.trackId=t.value),j.trackPage(i)}}else a||R.push(e)},unbind:function(e,t){var n=R.findIndex(function(t){return t===e});-1!==n&&R.splice(n,1)},update:function(t,e){}};function q(t){this._trackerInfo.eventName=t.type.toUpperCase(),j.trackDom(this,this._trackerInfo)}function B(){if(!d("historyInjected")){var i={url:"undefined"==typeof document||null==document.location?"":document.location.href},e=window.onpopstate;window.onpopstate=function(){var t={newURL:window.location.href,oldURL:i.url};if(i.url=window.location.href,o.apply(this,["historyPopstate",t]),e)return e.apply(this,arguments)};var r=window.history.pushState;r&&(window.history.pushState=function(t,e,n){var a={newURL:function(t,e){return/:\/\//.test(e)?e:t.match(/^.*:\/\/[^/]+/)[0]+(/^\//.test(e)?"":"/")+e}(i.url,n),oldURL:i.url};if(i={url:a.newURL},o.apply(this,["historyPushState",a]),r)return r.apply(this,arguments)}),a("historyInjected",!0)}function o(t,e){var n=new CustomEvent(t,{detail:e});window.dispatchEvent(n)}}function J(){O.change()}U.update=U.bind;var V=function(t){if(!d("install")){a("install"),B(),t&&I(t);var i=T();if(i.sendType===h&&b(),i.analyseScript)if(window.name.match(/\{trackerToken:.*\}/)){var e=document.getElementsByTagName("head").item(0),n=document.createElement("script");n.type="text/javascript",n.src=i.analyseScript,e.appendChild(n)}i.autoTrakerPage&&j.trackPage(),i.pageTime&&(O.start(),void 0===window.onpopstate&&window.addEventListener("hashchange",J),window.addEventListener("historyPushState",J),window.addEventListener("historyPopstate",J)),window.addEventListener("beforeunload",function(){i.pageTime&&O.end(),A(0,!0),i.sendType===h&&b()}),document.addEventListener("click",function(e){if(e.path&&e.isTrusted)for(var t=function(t){if("BODY"===t.tagName||!t.dataset)return"break";(t.dataset.track||i.autoTrakerClick&&("A"===t.tagName||"BUTTON"===t.tagName||"INPUT"===t.tagName)&&!t._isWatchTrack)&&("A"===e.target.tagName&&i.delayLink&&e.target.href?(e.preventDefault(),setTimeout(function(){j.trackDom(t),e.target.click()},i.delayLinkTime)):j.trackDom(t))},n=0,a=e.path;n<a.length;n++){if("break"===t(a[n]))break}},!1)}};if(window.addEventListener("load",function(){T().autoInstall&&V()}),"undefined"==typeof Symbol||"undefined"==typeof XMLHttpRequest)throw new Error("tracker requires ie10+");try{process.env.NODE_ENV}catch(t){var K="undefined"!=typeof window?window:global;"undefined"==typeof process&&(K.process={}),K.process.env={}}t.before=P,t.after=F,t.track=function(r,t,e){return c.isFunction(r)?function(t,e,i){return c.set("value",function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];var n=r.call(this,i.value,this);if("function"==typeof n)return n.apply(this,t);if("object"==typeof n){var a=o({},n);j.track(a)}return i.value.apply(this,arguments)},i)}:"object"==typeof r&&"function"==typeof r.constructor?e:"object"==typeof r?function(t,e,n){var a=n.value;return n.value=function(){var t=o({},r);return j.track(t),a.apply(this,arguments)},n}:function(t,e,n){var a=n.value;return n.value=function(){var t={trackId:r};return j.track(t),a.apply(this,arguments)},n}},t.trackView=U,t.trackEvent=function(e,n){if(!r(n)&&!s(n)){var t={};"object"==typeof n.value&&n.value?t=n.value:"string"==typeof n.value?t.trackId=n.value:"number"==typeof n.value&&(t.trackId=n.value+""),e._trackerInfo=t,e._isWatchTrack=!0;var a=Object.keys(n.modifiers).filter(function(t){return n.modifiers[t]});a.length||a.push("click"),a.forEach(function(t){e.removeEventListener(t,q,!1),e.addEventListener(t,q,!1)})}},t.install=V,t.pageTimeTracker=O,t.actionTracker=j,t.setConfig=I,t.getConfig=T,t.sendStorageData=b,t.sendAsyncData=A,t.send=_,t.sendSync=function(t){L([t=D(t,T())])},t.login=function(t){S=o({},S,t)},t.logout=function(){S={}},Object.defineProperty(t,"__esModule",{value:!0})});
//# sourceMappingURL=tracker.min.js.map
